# Переключение ширины сепараторов (Separator Width Toggle)

## Описание функции (Feature Description)
Функция позволяет переключать ширину временных разделителей (Separator_1 и Separator_2) между двумя режимами по клику:
- **Короткая (Short)**: Ширина колонки "Сегодня" - `(#BlockWidth_0#+4)`
- **Длинная (Long)**: Ширина всей сетки - `(#LineWidth#+4)`

---

## Архитектура (Architecture)

### 1. Переменные в Variables.ini
```ini
; Режим ширины разделителей (Separator width mode):
; Варианты (Options): 0-короткая (short, today only), 1-длинная (long, full grid)
Separator_1_WidthMode=1
Separator_2_WidthMode=1
```

**Где находятся**: `@Resources/Variables.ini`, строки 374-377

**Возможные значения**:
- `0` - Короткая ширина (только колонка "Сегодня")
- `1` - Длинная ширина (вся сетка)

### 2. Тултипы в Variables.ini
```ini
; Тултипы для кликабельных разделителей (Tooltips for clickable separators)
Separator_1_Tooltip_RU=Клик: Переключить ширину разделителя
Separator_1_Tooltip_EN=Click: Toggle separator width
Separator_2_Tooltip_RU=Клик: Переключить ширину разделителя
Separator_2_Tooltip_EN=Click: Toggle separator width
```

**Где находятся**: `@Resources/Variables.ini`, строки 553-558

### 3. Метры в OmniCal.ini
```ini
[HorizontalLine_Separator_1]
Meter=Shape
X=(#LeftMargin#-4)
Y=0
Shape=Rectangle 0,0,#Separator_1_CurrentWidth#,#Separator_1_Weight#,3,3 | Fill Color #ColorSeparator_1# | StrokeWidth 0 | Stroke Color #ColorSeparator_1#
Hidden=(1 - #Separator_1#)
LeftMouseUpAction=[!CommandMeasure OmniCal_Skin_lua "ToggleSeparatorWidth(1)"]
ToolTipText=[#Separator_1_Tooltip_[#Language]]
DynamicVariables=1

; Анимация для сепараторов (Animation for separators)
[MeasureSeparatorAnimation]
Measure=Plugin
Plugin=ActionTimer
ActionList1=Repeat AnimateSeparator1, 16, 20 | FinishSeparator1
AnimateSeparator1=[!SetVariable Separator_1_CurrentWidth "(Clamp(#Separator_1_CurrentWidth# + #Separator_1_WidthStep#, #Separator_1_WidthMin#, #Separator_1_WidthMax#))"][!UpdateMeter HorizontalLine_Separator_1][!Redraw]
FinishSeparator1=[!CommandMeasure OmniCal_Skin_lua "FinishSeparatorAnimation(1)"]
DynamicVariables=1
```

**Где находятся**: 
- Метры сепараторов: `OmniCal.ini`, строки 175-193
- ActionTimer мера: `OmniCal.ini`, строки 51-60

**Ключевые изменения**:
- `Shape` - использует переменную `#Separator_N_CurrentWidth#` вместо тернарного оператора
- `LeftMouseUpAction` - вызывает функцию через `OmniCal_Skin_lua` (имя Lua-меры)
- `ToolTipText` - показывает подсказку при наведении: `[#Separator_N_Tooltip_[#Language]]`
- `DynamicVariables=1` - обязателен для обновления ширины
- **Анимация**: `ActionTimer` выполняет 40 кадров по 10мс = ~400мс плавного перехода

### 4. Функция Lua в OmniCal_Skin.lua
```lua
-- Группа: [ Настройки скина ]
-- Описание: Переключает ширину разделителя (Toggles separator width)
-- @param separatorNumber: 1 или 2 (1 or 2)
function ToggleSeparatorWidth(separatorNumber)
    local varName = 'Separator_' .. separatorNumber .. '_WidthMode'
    local currentMode = SKIN:GetVariable(varName) or '1'
    local newMode = (currentMode == '1') and '0' or '1'
    
    -- Отладочный вывод (Debug output)
    if tonumber(SKIN:GetVariable('DebugMode')) == 1 then
        print("~~~~~~ToggleSeparatorWidth: separatorNumber=" .. separatorNumber .. ", currentMode=" .. currentMode .. ", newMode=" .. newMode)
    end
    
    -- Записать новое значение в файл Variables.ini (Write new value to Variables.ini)
    SKIN:Bang('!WriteKeyValue Variables ' .. varName .. ' "' .. newMode .. '" "#@#Variables.ini"')
    
    -- Обновить переменную (Update runtime variable)
    SKIN:Bang('!SetVariable ' .. varName .. ' "' .. newMode .. '"')
    
    -- Обновить метр разделителя (Update separator meter)
    SKIN:Bang('!UpdateMeter HorizontalLine_Separator_' .. separatorNumber)
    SKIN:Bang('!Redraw')
    
    -- Обновить время последнего действия (Update last action time)
    LastActionTime = os.time()
end
```

**Где находится**: `@Resources/OmniCal_Skin.lua`, строки 2643-2668

**Логика работы**:
1. Получает текущий режим ширины из переменной `Separator_N_WidthMode`
2. Переключает режим: `1 → 0` или `0 → 1`
3. Выводит отладочное сообщение (если `DebugMode=1`)
4. Сохраняет новое значение в `Variables.ini` (персистентность)
5. Обновляет runtime переменную
6. Перерисовывает метр разделителя
7. Обновляет время последнего действия (для автоскрытия настроек)

---

## Использование (Usage)

### Переключение ширины:
1. **Кликните левой кнопкой мыши** на разделитель (Separator_1 или Separator_2)
2. Ширина переключится между режимами:
   - **Короткая** → **Длинная**
   - **Длинная** → **Короткая**
3. Изменение **сохраняется** в `Variables.ini` и применяется после перезагрузки скина

### Проверка текущего режима:
1. Откройте `@Resources/Variables.ini`
2. Найдите переменные:
   ```ini
   Separator_1_WidthMode=1  ; 0=короткая, 1=длинная
   Separator_2_WidthMode=1
   ```

---

## Тестирование (Testing)

### Тест-план:
1. **Тест 1: Переключение Separator_1**
   - ✅ Начальное состояние: `Separator_1_WidthMode=1` (длинная)
   - ✅ Кликнуть на Separator_1 → ширина уменьшится до `BlockWidth_0`
   - ✅ Кликнуть снова → ширина увеличится до `LineWidth`
   - ✅ Проверить `Variables.ini` → значение изменилось

2. **Тест 2: Переключение Separator_2**
   - ✅ Начальное состояние: `Separator_2_WidthMode=1` (длинная)
   - ✅ Кликнуть на Separator_2 → ширина уменьшится
   - ✅ Кликнуть снова → ширина увеличится
   - ✅ Проверить `Variables.ini` → значение изменилось

3. **Тест 3: Независимость разделителей**
   - ✅ Установить Separator_1 в короткий режим, Separator_2 в длинный
   - ✅ Проверить, что они отображаются с разной шириной
   - ✅ Переключить Separator_1 → Separator_2 не изменился

4. **Тест 4: Персистентность**
   - ✅ Переключить оба разделителя в короткий режим
   - ✅ Перезагрузить скин (`[!Refresh]`)
   - ✅ Проверить, что ширина осталась короткой

5. **Тест 5: Тултипы**
   - ✅ Навести курсор на Separator_1 → тултип "Клик: Переключить ширину разделителя" (RU)
   - ✅ Переключить язык на EN → тултип "Click: Toggle separator width"

6. **Тест 6: Взаимодействие с видимостью**
   - ✅ Скрыть Separator_1 (`Separator_1=0`)
   - ✅ Переключить ширину Separator_1 → клик не работает (разделитель скрыт)
   - ✅ Показать Separator_1 → клик работает

---

## Известные ограничения (Known Limitations)
1. **Скрытые разделители**: Если `Separator_N=0` (разделитель скрыт), клик не работает (ожидаемое поведение).
2. **Зависимость от DynamicVariables**: Если удалить `DynamicVariables=1` из метра, ширина не будет обновляться.
3. **Расчет ширины**: Использует `BlockWidth_0` (может обновляться автоматически при изменении `todayHighlightWidth`).

---

## Настройка анимации (Animation Settings)

Параметры анимации вынесены в `@Resources\Variables.ini` для удобной настройки:

### Переменные в Variables.ini:
```ini
; Параметры анимации изменения ширины сепараторов (Separator width animation parameters):
; Интервал между кадрами в миллисекундах (Interval between frames in milliseconds):
SeparatorAnimationInterval=10

; Количество кадров анимации (Number of animation frames):
SeparatorAnimationFrames=40
```

**Текущие параметры**:
- **SeparatorAnimationInterval: 10мс** - Время между кадрами
- **SeparatorAnimationFrames: 40** - Количество шагов анимации
- **Общая продолжительность: 400мс** (10мс × 40 кадров)

### Как изменить скорость:

**1. Быстрая анимация (200мс)**:
```ini
SeparatorAnimationInterval=10
SeparatorAnimationFrames=20
```

**2. Плавная средняя (400мс) - по умолчанию**:
```ini
SeparatorAnimationInterval=10
SeparatorAnimationFrames=40
```

**3. Медленная плавная (600мс)**:
```ini
SeparatorAnimationInterval=12
SeparatorAnimationFrames=50
```

**4. Очень плавная (1 секунда)**:
```ini
SeparatorAnimationInterval=10
SeparatorAnimationFrames=100
```

### Рекомендации по настройке:

**Интервал (SeparatorAnimationInterval)**:
- **10мс** - Оптимально для плавности (~100 FPS)
- **16мс** - Стандарт (~60 FPS)
- **20мс и выше** - Могут быть заметны рывки

**Количество кадров (SeparatorAnimationFrames)**:
- **20-30** - Быстро, заметные ступени
- **40-50** - Оптимальный баланс плавности и скорости
- **60-100** - Очень плавно, но долго

**Формула продолжительности**: 
```
Продолжительность (мс) = SeparatorAnimationInterval × SeparatorAnimationFrames
```

**После изменения переменных**: Перезагрузите скин (`[!Refresh]`) для применения новых настроек.

---

## Устранение проблем (Troubleshooting)

### Проблема: Клик по сепаратору не работает
**Причина**: Неправильное имя Lua-меры в `LeftMouseUpAction`.

**Решение**: Убедитесь, что в `OmniCal.ini` используется правильное имя меры:
```ini
LeftMouseUpAction=[!CommandMeasure OmniCal_Skin_lua "ToggleSeparatorWidth(1)"]
```
**НЕ** `MeasureScript` или другое имя!

### Проверка работы функции:
1. Включите отладку в `Variables.ini`: `DebugMode=1`
2. Откройте Rainmeter → Log
3. Кликните по сепаратору
4. В логе должно появиться:
   ```
   ~~~~~~ToggleSeparatorWidth: separatorNumber=1, currentMode=1, newMode=0
   ```

---

## История изменений (Changelog)
- **2025-01-12**: Реализована функция переключения ширины сепараторов по клику.
  - Добавлены переменные `Separator_1_WidthMode`, `Separator_2_WidthMode` в Variables.ini
  - Изменены метры `HorizontalLine_Separator_1/2` в OmniCal.ini (динамическая ширина)
  - Добавлена функция `ToggleSeparatorWidth(N)` в OmniCal_Skin.lua
  - Добавлены тултипы на русском и английском языках
  - Реализована персистентность (сохранение в Variables.ini)
  - **БАГ-ФИХ**: Исправлено имя Lua-меры с `MeasureScript` на `OmniCal_Skin_lua`
  - Добавлен отладочный вывод для диагностики
  - **АНИМАЦИЯ**: Добавлена плавная анимация изменения ширины через ActionTimer
    - Продолжительность: ~400мс (40 кадров × 10мс)
    - Используется ActionTimer плагин для плавного перехода
    - Добавлена функция `FinishSeparatorAnimation()` для завершения анимации
    - Добавлена функция `InitializeSeparatorWidth()` для инициализации при загрузке

---

## См. также (See Also)
- **Функции видимости**: `Toggle_Separator_1()`, `Toggle_Separator_2()` - переключают показ/скрытие разделителей
- **Связанные переменные**: `Separator_N`, `Separator_N_Weight`, `Separator_N_Time`
- **Тултипы для панели настроек**: `SPtooltips_TimeSeparator_N_RU/EN`
